name: ğŸ¦€ Rust Lab CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  CARGO_TERM_COLOR: always

jobs:
  # Job para compilar y testear
  test:
    name: ğŸ§ª Tests & Compilation
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        rust-version: [stable, beta, nightly]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Configurar Rust ${{ matrix.rust-version }}
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust-version }}
        components: rustfmt, clippy
    
    - name: ğŸ“¦ Cache dependencias
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ matrix.rust-version }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.rust-version }}-
    
    - name: ğŸ”¨ Compilar proyecto
      run: cargo build --verbose --all-targets
    
    - name: ğŸ§ª Ejecutar tests
      run: cargo test --verbose
    
    - name: ğŸ“ Verificar formato de cÃ³digo
      run: cargo fmt --all -- --check
    
    - name: ğŸ” Ejecutar clippy (linter)
      run: cargo clippy --all-targets --all-features -- -D warnings
    
    - name: ğŸ“š Generar documentaciÃ³n
      run: cargo doc --no-deps --document-private-items

  # Job para benchmarks (solo en stable)
  benchmark:
    name: ğŸš€ Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Configurar Rust stable
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        components: rustfmt, clippy
    
    - name: ğŸ“¦ Cache dependencias
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-stable-${{ hashFiles('**/Cargo.lock') }}
    
    - name: ğŸƒâ€â™‚ï¸ Ejecutar benchmarks
      run: cargo bench --features benchmarks

  # Job para verificar ejercicios especÃ­ficos
  exercises:
    name: ğŸ¯ Verificar Ejercicios
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Configurar Rust stable
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
    
    - name: ğŸ“¦ Cache dependencias
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-exercises-${{ hashFiles('**/Cargo.lock') }}
    
    - name: ğŸ” Verificar ejercicios de Ownership
      run: |
        echo "ğŸ” Verificando ownership_basics..."
        cargo run --bin ownership_basics || echo "âœ… Error esperado (bugs intencionales)"
        
        echo "ğŸ” Verificando ownership_basics_fixed..."
        cargo run --bin ownership_basics_fixed
    
    - name: ğŸš¨ Verificar ejercicios de Error Handling
      run: |
        echo "ğŸ” Verificando error_handling_basics..."
        cargo run --bin error_handling_basics || echo "âœ… Error esperado (bugs intencionales)"

  # Job para generar reportes
  coverage:
    name: ğŸ“Š Coverage Report
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Configurar Rust stable
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
    
    - name: ğŸ“¦ Cache dependencias
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
    
    - name: ğŸ”§ Instalar tarpaulin (coverage tool)
      run: cargo install cargo-tarpaulin
    
    - name: ğŸ“Š Generar reporte de cobertura
      run: cargo tarpaulin --out Html --output-dir coverage/
    
    - name: ğŸ“¤ Subir reporte de cobertura
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/

  # Job para deployment (si tienes GitHub Pages)
  deploy:
    name: ğŸš€ Deploy Documentation
    runs-on: ubuntu-latest
    needs: [test, exercises]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Configurar Rust stable
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
    
    - name: ğŸ“š Generar documentaciÃ³n
      run: cargo doc --no-deps --document-private-items
    
    - name: ğŸš€ Deploy a GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./target/doc

